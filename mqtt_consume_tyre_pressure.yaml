metadata:
  name: mqtt_consume_tyre_pressure
  labels:
    nuclio.io/project-name: 7f15a68a-45e2-4006-a7cf-f5ec6148febd
spec:
  description: "Function that is invoked when a new message arrives on the iot/tyre/pressure queue, and insert data in the Database."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-mqtt_consume_tyre_pressure:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      kind: mqtt
      attributes:
        subscriptions:
          - topic: iot/tyre/pressure
            qos: 0
      workerAllocatorName: ""
      url: "guest:guest@172.30.92.172:1883"
  build:
    image: ""
    noCache: false
    offline: false
    dependencies: []
    runtimeAttributes:
      repositories: []
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBteXNxbCA9IHJlcXVpcmUoJ215c3FsJyk7Cgp2YXIgRlVOQ1RJT05fTkFNRSA9ICJtcXR0X2NvbnN1bWVfdHlyZV9wcmVzc3VyZSI7CgoKZnVuY3Rpb24gc2VuZF9mZWVkYmFjayhlcnIsIG1zZyl7CiAgICBpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAKICAgIHZhciBxID0gJ2lvdC90eXJlL2xvZ3MnOwogICAgYW1xcC5jb25uZWN0KCdhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAMTcyLjMwLjkyLjE3Mjo1NjcyJykudGhlbihmdW5jdGlvbihjb25uKSB7CiAgICAgICAgcmV0dXJuIGNvbm4uY3JlYXRlQ2hhbm5lbCgpLnRoZW4oZnVuY3Rpb24oY2gpIHsKICAgICAgICAgICAgdmFyIG9rID0gY2guYXNzZXJ0UXVldWUocSwge2R1cmFibGU6IGZhbHNlfSk7CiAgICAgICAgICAgIHJldHVybiBvay50aGVuKGZ1bmN0aW9uKF9xb2spIHsKICAgICAgICAgICAgICAgIGNoLnNlbmRUb1F1ZXVlKHEsIEJ1ZmZlci5mcm9tKG1zZykpOwogICAgICAgICAgICAgICAgY29uc29sZS5sb2coIiBbeF0gU2VudCAnJXMnIiwgbXNnKTsKICAgICAgICAgICAgICAgIHJldHVybiBjaC5jbG9zZSgpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KS5maW5hbGx5KGZ1bmN0aW9uKCkgeyAKICAgICAgICAgICAgY29ubi5jbG9zZSgpOwogICAgICAgIH0pOwogICAgfSkuY2F0Y2goY29uc29sZS53YXJuKTsKfQoKCmZ1bmN0aW9uIGluc2VydERhdGEoZGF0YSwgY2FsbGJhY2spewogICAgdmFyIHByZXNzdXJlOwogICAgdmFyIHRpbWVzdGFtcDsKICAgIAogICAgZnVuY3Rpb24gZm9ybWF0RGF0YShkYXRhKXsKICAgICAgICB2YXIgaW5kZXgxID0gZGF0YS5pbmRleE9mKCItIiwgMCk7CgkgICAgdmFyIGluZGV4MiA9IGluZGV4MSArIDE7CgoJICAgIC8vSWwgY2FyYXR0ZXJlIGxhIGN1aSBwb3NpemlvbmUgw6ggaW5kaWNhdGEgZGFsIHByaW1vIHBhcmFtZXRybyDDqCBpbmNsdXNvLgogICAgICAgIC8vSWwgY2FyYXR0ZXJlIGxhIGN1aSBwb3NpemlvbmUgw6ggaW5kaWNhdGEgZGFsIHNlY29uZG8gcGFyYW1ldHJvIE5PTiDDqCBpbmNsdXNvLgogICAgICAgIHByZXNzdXJlID0gZGF0YS5zdWJzdHJpbmcoMCwgaW5kZXgxKTsKCSAgICB0aW1lc3RhbXAgPSBkYXRhLnN1YnN0cmluZyhpbmRleDIpOwogICAgfQogICAgCiAgICBmb3JtYXREYXRhKGRhdGEpOwogIAoJdmFyIGNvbiA9IG15c3FsLmNyZWF0ZUNvbm5lY3Rpb24oeyAgCgkJaG9zdDogIjk1LjExMC4xNzEuMTgiLAogICAgICAgIHBvcnQ6ICIzMzA2IiwKCQl1c2VyOiAiMTAwNDlfMjI5IiwgIAoJCXBhc3N3b3JkOiAibWlrZTgxODAiLCAgCgkJZGF0YWJhc2U6ICJkYmluc3RhbmNlXzEwMDQ5XzEiICAKCX0pOwoKCXZhciBsYXN0X2lkPTA7CgoJY29uLmNvbm5lY3QoZnVuY3Rpb24oZXJyKSB7ICAKCQlpZiAoZXJyKSB0aHJvdyBlcnI7ICAKCQljb25zb2xlLmxvZygiQ29ubmVjdGVkISIpOyAKCQl2YXIgc3FsMSA9ICJTRUxFQ1QgTUFYKGlkKSBGUk9NIGRiaW5zdGFuY2VfMTAwNDlfMS5zY2lvdF9wcm9qZWN0OyIgCgoJCWNvbi5xdWVyeShzcWwxLCBmdW5jdGlvbiAoZXJyLCByZXN1bHQpIHsgIAoJCQlpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAgICAgICAgIGlmIChyZXN1bHQ9PW51bGwpewogICAgICAgICAgICAgICAgbGFzdF9pZD0wOwogICAgICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgICAgICBsYXN0X2lkID0gcmVzdWx0KzE7ICAKICAgICAgICAgICAgfQoJCQljb25zb2xlLmxvZygiTGFzdCBpZDogIiArIHJlc3VsdC50b1N0cmluZygpKTsKCQl9KTsgCgogICAgdmFyIHNxbDIgPSAiSU5TRVJUIElOVE8gZGJpbnN0YW5jZV8xMDA0OV8xLnNjaW90X3Byb2plY3QgKGlkLCBwcmVzc3VyZSwgdGltZXN0YW1wKSBWQUxVRVMgKCciKyBsYXN0X2lkICsiJywgJyIrcHJlc3N1cmUrIicsICciK3RpbWVzdGFtcCsiJykiOyAKCgkJY29uLnF1ZXJ5KHNxbDIsIGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkgeyAgCgkJCWlmIChlcnIpIHRocm93IGVycjsgIAoJCQljb25zb2xlLmxvZygiMSByZWNvcmQgaW5zZXJ0ZWQiKTsgIAogICAgICAgICAgICB2YXIgbXNnID0gIkZ1bmN0aW9uICciK0ZVTkNUSU9OX05BTUUrIicgaGFzIGJlZW4gdHJpZ2dlcmVkIGJ5IHRoZSBmb2xsb3dpbmcgbWVzc2FnZSByZWNlaXZlZCBvbiB0b3BpYyAnaW90L3R5cmUvcHJlc3N1cmUnOiAiKyBwcmVzc3VyZS50b1N0cmluZygpICsgIi0iICsgdGltZXN0YW1wLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG1zZyk7CgkJfSk7CgoJfSk7ICAKfQoKZnVuY3Rpb24gYmluMlN0cmluZyhhcnJheSl7Cgl2YXIgcmVzdWx0ID0gIiI7Cglmb3IodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpewoJCXJlc3VsdCs9IChTdHJpbmcuZnJvbUNoYXJDb2RlKGFycmF5W2ldKSk7Cgl9CglyZXR1cm4gcmVzdWx0Owp9CgpleHBvcnRzLmhhbmRsZXIgPSBmdW5jdGlvbihjb250ZXh0LCBldmVudCkgewoJdmFyIF9ldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTsKCXZhciBfZGF0YSA9IGJpbjJTdHJpbmcoX2V2ZW50LmJvZHkuZGF0YSk7CiAgICAKICAgIGluc2VydERhdGEoX2RhdGEsIGZ1bmN0aW9uKGVyciwgZGF0YSl7CiAgICAgICAgc2VuZF9mZWVkYmFjayhudWxsLCBkYXRhKTsKICAgIH0pCiAgICAKICAgIGNvbnRleHQuY2FsbGJhY2soImZlZWRiYWNrIik7Cn07
    commands:
      - 'npm install amqplib'
      - 'npm install mysql'
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
