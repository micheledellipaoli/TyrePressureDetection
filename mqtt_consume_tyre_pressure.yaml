metadata:
  name: mqtt_consume_tyre_pressure
  labels:
    nuclio.io/project-name: 7f15a68a-45e2-4006-a7cf-f5ec6148febd
spec:
  description: "Function that is invoked when a new message arrives on the iot/tyre/pressure queue, and insert data in the Database."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-mqtt_consume_tyre_pressure:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      kind: mqtt
      attributes:
        subscriptions:
          - topic: iot/tyre/pressure
            qos: 0
      workerAllocatorName: ""
      url: "guest:guest@172.22.91.115:1883"
  build:
    image: ""
    noCache: false
    offline: false
    dependencies: []
    runtimeAttributes:
      repositories: []
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBteXNxbCA9IHJlcXVpcmUoJ215c3FsJyk7Cgp2YXIgRlVOQ1RJT05fTkFNRSA9ICJtcXR0X2NvbnN1bWVfdHlyZV9wcmVzc3VyZSI7Cgp2YXIgREFUQUJBU0VfSE9TVCA9ICI5NS4xMTAuMTcxLjE4IjsKdmFyIERBVEFCQVNFX1BPUlQgPSAiMzMwNiI7CnZhciBEQVRBQkFTRV9VU0VSID0gIjEwMDQ5XzIyOSI7CnZhciBEQVRBQkFTRV9QQVNTV09SRCA9ICJtaWtlODE4MCI7ICAKdmFyIERBVEFCQVNFX05BTUUgPSAiZGJpbnN0YW5jZV8xMDA0OV8xIjsgCnZhciBEQVRBQkFTRV9UQUJMRV9OQU1FID0gInNjaW90X3Byb2plY3QiOwoKCmZ1bmN0aW9uIHNlbmRfZmVlZGJhY2soZXJyLCBtc2cpewogICAgaWYgKGVycikgdGhyb3cgZXJyOwogICAgCiAgICB2YXIgcSA9ICdpb3QvdHlyZS9sb2dzJzsKICAgIGFtcXAuY29ubmVjdCgnYW1xcDovL2d1ZXN0Omd1ZXN0QDE3Mi4yMi45MS4xMTU6NTY3MicpLnRoZW4oZnVuY3Rpb24oY29ubikgewogICAgICAgIHJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgICAgIHZhciBvayA9IGNoLmFzc2VydFF1ZXVlKHEsIHtkdXJhYmxlOiBmYWxzZX0pOwogICAgICAgICAgICByZXR1cm4gb2sudGhlbihmdW5jdGlvbihfcW9rKSB7CiAgICAgICAgICAgICAgICBjaC5zZW5kVG9RdWV1ZShxLCBCdWZmZXIuZnJvbShtc2cpKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCIgW3hdIFNlbnQgJyVzJyIsIG1zZyk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2guY2xvc2UoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkuZmluYWxseShmdW5jdGlvbigpIHsgCiAgICAgICAgICAgIGNvbm4uY2xvc2UoKTsKICAgICAgICB9KTsKICAgIH0pLmNhdGNoKGNvbnNvbGUud2Fybik7Cn0KCgpmdW5jdGlvbiBpbnNlcnREYXRhKGRhdGEsIGNhbGxiYWNrKXsKICAgIHZhciBwcmVzc3VyZTsKICAgIHZhciB0aW1lc3RhbXA7CiAgICAKICAgIGZ1bmN0aW9uIGZvcm1hdERhdGEoZGF0YSl7CiAgICAgICAgdmFyIGluZGV4MSA9IGRhdGEuaW5kZXhPZigiLSIsIDApOwoJICAgIHZhciBpbmRleDIgPSBpbmRleDEgKyAxOwoKCSAgICAvL0lsIGNhcmF0dGVyZSBsYSBjdWkgcG9zaXppb25lIMOoIGluZGljYXRhIGRhbCBwcmltbyBwYXJhbWV0cm8gw6ggaW5jbHVzby4KICAgICAgICAvL0lsIGNhcmF0dGVyZSBsYSBjdWkgcG9zaXppb25lIMOoIGluZGljYXRhIGRhbCBzZWNvbmRvIHBhcmFtZXRybyBOT04gw6ggaW5jbHVzby4KICAgICAgICBwcmVzc3VyZSA9IGRhdGEuc3Vic3RyaW5nKDAsIGluZGV4MSk7CgkgICAgdGltZXN0YW1wID0gZGF0YS5zdWJzdHJpbmcoaW5kZXgyKTsKICAgIH0KICAgIAogICAgZm9ybWF0RGF0YShkYXRhKTsKICAKCXZhciBjb24gPSBteXNxbC5jcmVhdGVDb25uZWN0aW9uKHsgIAoJCWhvc3Q6IERBVEFCQVNFX0hPU1QsCiAgICAgICAgcG9ydDogREFUQUJBU0VfUE9SVCwKCQl1c2VyOiBEQVRBQkFTRV9VU0VSLCAgCgkJcGFzc3dvcmQ6IERBVEFCQVNFX1BBU1NXT1JELCAgCgkJZGF0YWJhc2U6IERBVEFCQVNFX05BTUUgIAoJfSk7CgoJdmFyIGxhc3RfaWQ9MDsKCgljb24uY29ubmVjdChmdW5jdGlvbihlcnIpIHsgIAoJCWlmIChlcnIpIHRocm93IGVycjsgIAoJCWNvbnNvbGUubG9nKCJDb25uZWN0ZWQhIik7IAoJCXZhciBzcWwxID0gIlNFTEVDVCBNQVgoaWQpIEZST00gIiArIERBVEFCQVNFX05BTUUgKyAiLiIgKyBEQVRBQkFTRV9UQUJMRV9OQU1FKyI7IiAKCgkJY29uLnF1ZXJ5KHNxbDEsIGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkgeyAgCgkJCWlmIChlcnIpIHRocm93IGVycjsKICAgICAgICAgICAgaWYgKHJlc3VsdD09bnVsbCl7CiAgICAgICAgICAgICAgICBsYXN0X2lkPTA7CiAgICAgICAgICAgIH0gZWxzZXsKICAgICAgICAgICAgICAgIGxhc3RfaWQgPSByZXN1bHQrMTsgIAogICAgICAgICAgICB9CgkJCWNvbnNvbGUubG9nKCJMYXN0IGlkOiAiICsgcmVzdWx0LnRvU3RyaW5nKCkpOwoJCX0pOyAKCiAgICB2YXIgc3FsMiA9ICJJTlNFUlQgSU5UTyAiICsgREFUQUJBU0VfTkFNRSArICIuIiArIERBVEFCQVNFX1RBQkxFX05BTUUrIiAoaWQsIHByZXNzdXJlLCB0aW1lc3RhbXApIFZBTFVFUyAoJyIrIGxhc3RfaWQgKyInLCAnIitwcmVzc3VyZSsiJywgJyIrdGltZXN0YW1wKyInKSI7IAoKCQljb24ucXVlcnkoc3FsMiwgZnVuY3Rpb24gKGVyciwgcmVzdWx0KSB7ICAKCQkJaWYgKGVycikgdGhyb3cgZXJyOyAgCgkJCWNvbnNvbGUubG9nKCIxIHJlY29yZCBpbnNlcnRlZCIpOyAgCiAgICAgICAgICAgIHZhciBtc2cgPSAiRnVuY3Rpb24gJyIrRlVOQ1RJT05fTkFNRSsiJyBoYXMgYmVlbiB0cmlnZ2VyZWQgYnkgdGhlIGZvbGxvd2luZyBtZXNzYWdlIHJlY2VpdmVkIG9uIHRvcGljICdpb3QvdHlyZS9wcmVzc3VyZSc6ICIrIHByZXNzdXJlLnRvU3RyaW5nKCkgKyAiLSIgKyB0aW1lc3RhbXAudG9TdHJpbmcoKTsKICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgbXNnKTsKCQl9KTsKCgl9KTsgIAp9CgpmdW5jdGlvbiBiaW4yU3RyaW5nKGFycmF5KXsKCXZhciByZXN1bHQgPSAiIjsKCWZvcih2YXIgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7ICsraSl7CgkJcmVzdWx0Kz0gKFN0cmluZy5mcm9tQ2hhckNvZGUoYXJyYXlbaV0pKTsKCX0KCXJldHVybiByZXN1bHQ7Cn0KCmV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7Cgl2YXIgX2V2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpOwoJdmFyIF9kYXRhID0gYmluMlN0cmluZyhfZXZlbnQuYm9keS5kYXRhKTsKICAgIAogICAgaW5zZXJ0RGF0YShfZGF0YSwgZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICBzZW5kX2ZlZWRiYWNrKG51bGwsIGRhdGEpOwogICAgfSkKICAgIAogICAgY29udGV4dC5jYWxsYmFjaygiZmVlZGJhY2siKTsKfTs=
    commands:
      - 'npm install amqplib'
      - 'npm install mysql'
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
