metadata:
  name: mqtt_interpreter
  labels:
    nuclio.io/project-name: 7f15a68a-45e2-4006-a7cf-f5ec6148febd
spec:
  description: "Function invoked when a new message arrives on the iot/tyre/pressure queue. It retrieves the last 5 rows from Database, interpret datas, and send a message on the iot/console queue."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-mqtt_interpreter:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      class: ""
      kind: mqtt
      url: "guest:guest@172.24.23.53:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/tyre/pressure
  build:
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBteXNxbCA9IHJlcXVpcmUoJ215c3FsJyk7IAoKdmFyIEZVTkNUSU9OX05BTUUgPSAibXF0dF9pbnRlcnByZXRlciI7Cgp2YXIgREFUQUJBU0VfSE9TVCA9ICIxNzIuMjQuMjMuNTMiOwp2YXIgREFUQUJBU0VfUE9SVCA9ICIzMzA2MCI7CnZhciBEQVRBQkFTRV9VU0VSID0gInJvb3QiOwp2YXIgREFUQUJBU0VfUEFTU1dPUkQgPSAiMTIzNCI7ICAKdmFyIERBVEFCQVNFX05BTUUgPSAic2Npb3RfcHJvamVjdCI7IAp2YXIgREFUQUJBU0VfVEFCTEVfTkFNRSA9ICJ0eXJlX3ByZXNzdXJlIjsKCmZ1bmN0aW9uIHJldHJpZXZlRGF0YShjYWxsYmFjayl7CiAgICAKICAJdmFyIGNvbiA9IG15c3FsLmNyZWF0ZUNvbm5lY3Rpb24oeyAgCgkJaG9zdDogREFUQUJBU0VfSE9TVCwKICAgICAgICBwb3J0OiBEQVRBQkFTRV9QT1JULAoJCXVzZXI6IERBVEFCQVNFX1VTRVIsICAKCQlwYXNzd29yZDogREFUQUJBU0VfUEFTU1dPUkQsICAKCQlkYXRhYmFzZTogREFUQUJBU0VfTkFNRSAgICAKCX0pOwoKCWNvbi5jb25uZWN0KGZ1bmN0aW9uKGVycikgeyAgCgkJaWYgKGVycikgdGhyb3cgZXJyOyAgCgkJY29uc29sZS5sb2coIkNvbm5lY3RlZCEiKTsKCgkJdmFyIHNxbDEgPSAiU0VMRUNUICogRlJPTSAoU0VMRUNUICogRlJPTSAiICsgREFUQUJBU0VfTkFNRSArICIuIiArIERBVEFCQVNFX1RBQkxFX05BTUUrIiBPUkRFUiBCWSBpZCBERVNDIExJTUlUIDUpIHN1YiBPUkRFUiBCWSB0aW1lc3RhbXAgQVNDOyI7CgkJCgkJY29uLnF1ZXJ5KHNxbDEsIGZ1bmN0aW9uIChlcnIsIHJlc3VsdHMpIHsgIAoJCQlpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAgIAkJY29uc29sZS5sb2cocmVzdWx0cy5sZW5ndGggKyAiIHJlY29yZHMgcmV0cmlldmVkXG4iKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpOwoJCX0pOwoJfSk7IAp9CgpmdW5jdGlvbiBpbnRlcnByZXREYXRhKGVyciwgcmVzdWx0cywgY2FsbGJhY2spIHsKICAgIGlmIChlcnIpIHRocm93IGVycjsKICAgIAogICAgdmFyIHByZXNzdXJlVmFsdWVzID0gbmV3IEFycmF5KCk7CiAgICB2YXIgdGltZXN0YW1wVmFsdWVzID0gbmV3IEFycmF5KCk7CiAgICB2YXIgbnVtUmVzdWx0cyA9IHJlc3VsdHMubGVuZ3RoOwogICAgdmFyIGRlbHRhID0gMDsKCiAJdmFyIHN0YW5kYXJkUHJlc3N1cmUgPSAzMjsKCXZhciBtZXNzYWdlPSIiOwoKICAgIC8vIGl0ZXJhIHR1dHRlIGxlIHJpZ2hlIGRlbGwnb2dnZXR0byByZXN1bHQKCWZvcih2YXIgaT0wOyBpPHJlc3VsdHMubGVuZ3RoOyBpKyspewoJCXByZXNzdXJlVmFsdWVzW2ldID0gcmVzdWx0c1tpXS5wcmVzc3VyZS50b1N0cmluZygpOwoJCXRpbWVzdGFtcFZhbHVlc1tpXSA9IHJlc3VsdHNbaV0udGltZXN0YW1wLnRvU3RyaW5nKCk7CgkJY29uc29sZS5sb2coInByZXNzdXJlOiAiK3ByZXNzdXJlVmFsdWVzW2ldKTsKICAgICAgCWNvbnNvbGUubG9nKCJ0aW1lc3RhbXA6ICIrdGltZXN0YW1wVmFsdWVzW2ldKTsKCX07CiAgICAKCS8vQ2FzbyAxOiBOdW1lcm8gZGkgcmVjb3JkIHByZXNlbnRpIG5lbCBEQiBtaW5vcmUgZGkgNQoJaWYobnVtUmVzdWx0czw1KXsKCQkvL0Nhc28gMS4xOiB1bHRpbW8gdmFsb3JlIG1pbm9yZSBkaSBxdWVsbG8gc3RhbmRhcmQKCQlpZiAocHJlc3N1cmVWYWx1ZXNbbnVtUmVzdWx0cy0xXSA8IHN0YW5kYXJkUHJlc3N1cmUpewoJCQltZXNzYWdlID0gIkxvdyBUeXJlIFByZXNzdXJlIHJlZ2lzdGVyZWQhIjsKCQl9ZWxzZXsKCQkJLy9DYXNvIDEuMjogcGVudWxtdGltbyB2YWxvcmUgbWlub3JlIGRpIHF1ZWxsbyBzdGFuZGFyZCAmJiB1bHRpbW8gdmFsb3JlIG1hZ2dpb3JlIG8gdWd1YWxlIGRpIHF1ZWxsbyBzdGFuZGFyZAoJCQlpZiAoIChwcmVzc3VyZVZhbHVlc1tudW1SZXN1bHRzLTJdIDwgc3RhbmRhcmRQcmVzc3VyZSkgJiYgKHByZXNzdXJlVmFsdWVzW251bVJlc3VsdHMtMV0gPj0gc3RhbmRhcmRQcmVzc3VyZSkgKXsKCQkJCW1lc3NhZ2UgPSAiVHlyZSBwcmVzc3VyZSByZXN0b3JlZCEiOwoJCQl9CgkJfQoJfWVsc2V7CgkJLy9DYXNvIDI6IE51bWVybyBkaSByZWNvcmQgcHJlc2VudGkgbmVsIERCIG1hZ2dpb3JlIG8gdWd1YWxlIGRpIDUgCiAgICAgICAgCiAgICAgICAgLy9DYXNvIDIuMTogdmFsb3JpIGRpIHByZXNzaW9uZSBkZWNyZXNjZW50aQogICAgICAgIGlmKCAocHJlc3N1cmVWYWx1ZXNbMF0gPCBzdGFuZGFyZFByZXNzdXJlKSAmJiAocHJlc3N1cmVWYWx1ZXNbMF0+PSBwcmVzc3VyZVZhbHVlc1sxXSkgJiYgKHByZXNzdXJlVmFsdWVzWzFdPj0gcHJlc3N1cmVWYWx1ZXNbMl0pICYmIChwcmVzc3VyZVZhbHVlc1syXT49IHByZXNzdXJlVmFsdWVzWzNdKSAmJiAocHJlc3N1cmVWYWx1ZXNbM10+PSBwcmVzc3VyZVZhbHVlc1s0XSkgKXsKCQkJCQkJCgkJCXZhciBzdGFydFRpbWUgPSBEYXRlLnBhcnNlKG5ldyBEYXRlKHRpbWVzdGFtcFZhbHVlc1swXS50b1N0cmluZygpKSk7CgkJCXZhciBlbmRUaW1lID0gRGF0ZS5wYXJzZSh0aW1lc3RhbXBWYWx1ZXNbNF0udG9TdHJpbmcoKSk7CgoJCQkvL0RpZmZlcmVuemEgaW4gbWludXRpCgkJCWRlbHRhID0gTWF0aC5mbG9vcigoKGVuZFRpbWUtc3RhcnRUaW1lKS8xMDAwLzYwKSk7CgkJCQoJCQkvL0Nhc28gMi4xLjE6IERpZmZlcmVuemEgZGkgdGltZXN0YW1wIG1pbm9yZSBkaSAxIG1pbnV0bwoJCQlpZihkZWx0YTwxKXsKCQkJCW1lc3NhZ2UgPSAiV2FybmluZywgcG9zc2libGUgdHlyZSBwdW5jdHVyZSEiOwoJCQl9ZWxzZXsKCQkJCS8vQ2FzbyAyLjEuMjogRGlmZmVyZW56YSBkaSB0aW1lc3RhbXAgbWFnZ2lvcmUgbyB1Z3VhbGUgZGkgMSBtaW51dG8KCQkJCW1lc3NhZ2UgPSAiTG93IFR5cmUgUHJlc3N1cmUgcmVnaXN0ZXJlZCEiOwoJCQl9CiAgICAgICAgfWVsc2V7CiAgICAgICAgLy9DYXNvIDIuMjogdmFsb3JpIGRpIHByZXNzaW9uZSBOT04gZGVjcmVzY2VudGkKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vQ2FzbyAyLjIuMDogdWx0aW1vIHZhbG9yZSBtYWdnaW9yZSBkaSBxdWVsbG8gc3RhbmRhcmQKICAgICAgICAgICAgaWYgKHByZXNzdXJlVmFsdWVzWzRdID49IHN0YW5kYXJkUHJlc3N1cmUpewoJCQkgICAgbWVzc2FnZSA9ICJUeXJlIHByZXNzdXJlIHJlc3RvcmVkISI7CgkJICAgIH0KICAgICAgICAgICAgLy9DYXNvIDIuMi4xOiB1bHRpbW8gdmFsb3JlIG1pbm9yZSBkaSBxdWVsbG8gc3RhbmRhcmQKCQkgICAgaWYgKHByZXNzdXJlVmFsdWVzW251bVJlc3VsdHMtMV0gPCBzdGFuZGFyZFByZXNzdXJlKXsKCQkJICAgIG1lc3NhZ2UgPSAiTG93IFR5cmUgUHJlc3N1cmUgcmVnaXN0ZXJlZCEiOwoJCSAgICB9ZWxzZXsKCQkJICAgIC8vQ2FzbyAyLjIuMjogcGVudWxtdGltbyB2YWxvcmUgbWlub3JlIGRpIHF1ZWxsbyBzdGFuZGFyZCAmJiB1bHRpbW8gdmFsb3JlIG1hZ2dpb3JlIG8gdWd1YWxlIGRpIHF1ZWxsbyBzdGFuZGFyZAoJCQkgICAgaWYgKCAocHJlc3N1cmVWYWx1ZXNbbnVtUmVzdWx0cy0yXSA8IHN0YW5kYXJkUHJlc3N1cmUpICYmIChwcmVzc3VyZVZhbHVlc1tudW1SZXN1bHRzLTFdID49IHN0YW5kYXJkUHJlc3N1cmUpICl7CgkJCQkgICAgbWVzc2FnZSA9ICJUeXJlIHByZXNzdXJlIHJlc3RvcmVkISI7CgkJCSAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAvL0Nhc28gMi4yLjM6IHBlbnVsdGltbyBlZCB1bHRpbW8gdmFsb3JlIG1hZ2dpb3JpIGRpIHF1ZWxsbyBzdGFuZGFyZAogICAgICAgICAgICAgICAgICAgIGlmKCAocHJlc3N1cmVWYWx1ZXNbbnVtUmVzdWx0cy0yXSA+PSBzdGFuZGFyZFByZXNzdXJlKSAmJiAocHJlc3N1cmVWYWx1ZXNbbnVtUmVzdWx0cy0xXSA+PSBzdGFuZGFyZFByZXNzdXJlKSApewogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gIlR5cmUgUHJlc3N1cmUgb3B0aW1hbCEiOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCQkgICAgfQogICAgICAgIH0KICAgICAgICAKCX0KICAgIGNvbnNvbGUubG9nKCdtZXNzYWdlOiAnK21lc3NhZ2UpOwogIAljYWxsYmFjayhudWxsLCBtZXNzYWdlKTsKfQoKZnVuY3Rpb24gc2VuZF9mZWVkYmFjayhlcnIsIG1zZyl7CiAgICBpZihlcnIpIHRocm93IGVycjsKICAgIAogICAgY29uc29sZS5sb2coIlxuc2VuZF9mZWVkYmFja1ttc2ddOiAiK21zZyk7Cgl2YXIgcSA9ICdpb3QvY29uc29sZSc7CglhbXFwLmNvbm5lY3QoJ2FtcXA6Ly9ndWVzdDpndWVzdEAxNzIuMjQuMjMuNTM6NTY3MicpLnRoZW4oZnVuY3Rpb24oY29ubikgewoJCXJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoKSB7CgkJCXZhciBvayA9IGNoLmFzc2VydFF1ZXVlKHEsIHtkdXJhYmxlOiBmYWxzZX0pOwoJCQlyZXR1cm4gb2sudGhlbihmdW5jdGlvbihfcW9rKSB7CgkJCQljaC5zZW5kVG9RdWV1ZShxLCBCdWZmZXIuZnJvbShtc2cpKTsKCQkJCWNvbnNvbGUubG9nKCIgW3hdIFNlbnQgJyVzJyIsIG1zZyk7CgkJCQlyZXR1cm4gY2guY2xvc2UoKTsKCQkJfSk7CgkJfSkuZmluYWxseShmdW5jdGlvbigpIHsKCQkJY29ubi5jbG9zZSgpOwoJCX0pOwoJfSkuY2F0Y2goY29uc29sZS53YXJuKTsKfQoKZXhwb3J0cy5oYW5kbGVyID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCSAgICByZXRyaWV2ZURhdGEoZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICAgICAgaW50ZXJwcmV0RGF0YShudWxsLCBkYXRhLCBmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgICAgIHNlbmRfZmVlZGJhY2sobnVsbCwgZGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pCiAgICB9LCAxMDAwKTsKICAgIGNvbnRleHQuY2FsbGJhY2soImZlZWRiYWNrIik7Cn07
    commands:
      - 'npm install amqplib'
      - 'npm install mysql'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
  version: 1
