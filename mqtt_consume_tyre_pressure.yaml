metadata:
  name: mqtt_consume_tyre_pressure
  labels:
    nuclio.io/project-name: 7f15a68a-45e2-4006-a7cf-f5ec6148febd
spec:
  description: "Function that is invoked when a new message arrives on the iot/tyre/pressure queue, and insert data in the Database."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-mqtt_consume_tyre_pressure:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      kind: mqtt
      attributes:
        subscriptions:
          - topic: iot/tyre/pressure
            qos: 0
      workerAllocatorName: ""
      url: "guest:guest@172.22.83.67:1883"
  build:
    image: ""
    noCache: false
    offline: false
    dependencies: []
    runtimeAttributes:
      repositories: []
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBteXNxbCA9IHJlcXVpcmUoJ215c3FsJyk7Cgp2YXIgRlVOQ1RJT05fTkFNRSA9ICJtcXR0X2NvbnN1bWVfdHlyZV9wcmVzc3VyZSI7Cgp2YXIgREFUQUJBU0VfSE9TVCA9ICIxNzIuMjIuODMuNjciOwp2YXIgREFUQUJBU0VfUE9SVCA9ICIzMzA2MCI7CnZhciBEQVRBQkFTRV9VU0VSID0gInJvb3QiOwp2YXIgREFUQUJBU0VfUEFTU1dPUkQgPSAiMTIzNCI7ICAKdmFyIERBVEFCQVNFX05BTUUgPSAic2Npb3RfcHJvamVjdCI7IAp2YXIgREFUQUJBU0VfVEFCTEVfTkFNRSA9ICJ0eXJlX3ByZXNzdXJlIjsKCgpmdW5jdGlvbiBzZW5kX2ZlZWRiYWNrKGVyciwgbXNnKXsKICAgIGlmIChlcnIpIHRocm93IGVycjsKICAgIAogICAgdmFyIHEgPSAnaW90L3R5cmUvbG9ncyc7CiAgICBhbXFwLmNvbm5lY3QoJ2FtcXA6Ly9ndWVzdDpndWVzdEAxNzIuMjIuODMuNjc6NTY3MicpLnRoZW4oZnVuY3Rpb24oY29ubikgewogICAgICAgIHJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoKSB7CiAgICAgICAgICAgIHZhciBvayA9IGNoLmFzc2VydFF1ZXVlKHEsIHtkdXJhYmxlOiBmYWxzZX0pOwogICAgICAgICAgICByZXR1cm4gb2sudGhlbihmdW5jdGlvbihfcW9rKSB7CiAgICAgICAgICAgICAgICBjaC5zZW5kVG9RdWV1ZShxLCBCdWZmZXIuZnJvbShtc2cpKTsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCIgW3hdIFNlbnQgJyVzJyIsIG1zZyk7CiAgICAgICAgICAgICAgICByZXR1cm4gY2guY2xvc2UoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkuZmluYWxseShmdW5jdGlvbigpIHsgCiAgICAgICAgICAgIGNvbm4uY2xvc2UoKTsKICAgICAgICB9KTsKICAgIH0pLmNhdGNoKGNvbnNvbGUud2Fybik7Cn0KCgpmdW5jdGlvbiBpbnNlcnREYXRhKGRhdGEsIGNhbGxiYWNrKXsKICAgIHZhciBwcmVzc3VyZTsKICAgIHZhciB0aW1lc3RhbXA7CiAgICAKICAgIGZ1bmN0aW9uIGZvcm1hdERhdGEoZGF0YSl7CiAgICAgICAgdmFyIGluZGV4MSA9IGRhdGEuaW5kZXhPZigiLSIsIDApOwoJICAgIHZhciBpbmRleDIgPSBpbmRleDEgKyAxOwoKCSAgICAvL0lsIGNhcmF0dGVyZSBsYSBjdWkgcG9zaXppb25lIMOoIGluZGljYXRhIGRhbCBwcmltbyBwYXJhbWV0cm8gw6ggaW5jbHVzby4KICAgICAgICAvL0lsIGNhcmF0dGVyZSBsYSBjdWkgcG9zaXppb25lIMOoIGluZGljYXRhIGRhbCBzZWNvbmRvIHBhcmFtZXRybyBOT04gw6ggaW5jbHVzby4KICAgICAgICBwcmVzc3VyZSA9IGRhdGEuc3Vic3RyaW5nKDAsIGluZGV4MSk7CgkgICAgdGltZXN0YW1wID0gZGF0YS5zdWJzdHJpbmcoaW5kZXgyKTsKICAgIH0KICAgIAogICAgZm9ybWF0RGF0YShkYXRhKTsKICAKCXZhciBjb24gPSBteXNxbC5jcmVhdGVDb25uZWN0aW9uKHsgIAoJCWhvc3Q6IERBVEFCQVNFX0hPU1QsCiAgICAgICAgcG9ydDogREFUQUJBU0VfUE9SVCwKCQl1c2VyOiBEQVRBQkFTRV9VU0VSLCAgCgkJcGFzc3dvcmQ6IERBVEFCQVNFX1BBU1NXT1JELCAgCgkJZGF0YWJhc2U6IERBVEFCQVNFX05BTUUgICAgICAKCX0pOwoKCXZhciBsYXN0X2lkPTA7CgoJY29uLmNvbm5lY3QoZnVuY3Rpb24oZXJyKSB7ICAKCQlpZiAoZXJyKSB0aHJvdyBlcnI7ICAKCQljb25zb2xlLmxvZygiQ29ubmVjdGVkISIpOyAKCQl2YXIgc3FsMSA9ICJTRUxFQ1QgTUFYKGlkKSBGUk9NICIgKyBEQVRBQkFTRV9OQU1FICsgIi4iICsgREFUQUJBU0VfVEFCTEVfTkFNRSsiOyIgCgoJCWNvbi5xdWVyeShzcWwxLCBmdW5jdGlvbiAoZXJyLCByZXN1bHQpIHsgIAoJCQlpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAgICAgICAgIGlmIChyZXN1bHQ9PW51bGwpewogICAgICAgICAgICAgICAgbGFzdF9pZD0wOwogICAgICAgICAgICB9IGVsc2V7CiAgICAgICAgICAgICAgICBsYXN0X2lkID0gcmVzdWx0KzE7ICAKICAgICAgICAgICAgfQoJCQljb25zb2xlLmxvZygiTGFzdCBpZDogIiArIHJlc3VsdC50b1N0cmluZygpKTsKCQl9KTsgCgogICAgdmFyIHNxbDIgPSAiSU5TRVJUIElOVE8gIiArIERBVEFCQVNFX05BTUUgKyAiLiIgKyBEQVRBQkFTRV9UQUJMRV9OQU1FKyIgKGlkLCBwcmVzc3VyZSwgdGltZXN0YW1wKSBWQUxVRVMgKCciKyBsYXN0X2lkICsiJywgJyIrcHJlc3N1cmUrIicsICciK3RpbWVzdGFtcCsiJykiOyAKCgkJY29uLnF1ZXJ5KHNxbDIsIGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkgeyAgCgkJCWlmIChlcnIpIHRocm93IGVycjsgIAoJCQljb25zb2xlLmxvZygiMSByZWNvcmQgaW5zZXJ0ZWQiKTsgIAogICAgICAgICAgICB2YXIgbXNnID0gIkZ1bmN0aW9uICciK0ZVTkNUSU9OX05BTUUrIicgaGFzIGJlZW4gdHJpZ2dlcmVkIGJ5IHRoZSBmb2xsb3dpbmcgbWVzc2FnZSByZWNlaXZlZCBvbiB0b3BpYyAnaW90L3R5cmUvcHJlc3N1cmUnOiAiKyBwcmVzc3VyZS50b1N0cmluZygpICsgIi0iICsgdGltZXN0YW1wLnRvU3RyaW5nKCk7CiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIG1zZyk7CgkJfSk7CgoJfSk7ICAKfQoKZnVuY3Rpb24gYmluMlN0cmluZyhhcnJheSl7Cgl2YXIgcmVzdWx0ID0gIiI7Cglmb3IodmFyIGkgPSAwOyBpIDwgYXJyYXkubGVuZ3RoOyArK2kpewoJCXJlc3VsdCs9IChTdHJpbmcuZnJvbUNoYXJDb2RlKGFycmF5W2ldKSk7Cgl9CglyZXR1cm4gcmVzdWx0Owp9CgpleHBvcnRzLmhhbmRsZXIgPSBmdW5jdGlvbihjb250ZXh0LCBldmVudCkgewoJdmFyIF9ldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTsKCXZhciBfZGF0YSA9IGJpbjJTdHJpbmcoX2V2ZW50LmJvZHkuZGF0YSk7CiAgICAKICAgIGluc2VydERhdGEoX2RhdGEsIGZ1bmN0aW9uKGVyciwgZGF0YSl7CiAgICAgICAgc2VuZF9mZWVkYmFjayhudWxsLCBkYXRhKTsKICAgIH0pCiAgICAKICAgIGNvbnRleHQuY2FsbGJhY2soImZlZWRiYWNrIik7Cn07
    commands:
      - 'npm install amqplib'
      - 'npm install mysql'
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
