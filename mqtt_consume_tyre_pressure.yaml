metadata:
  name: mqtt_consume_tyre_pressure
  labels:
    nuclio.io/project-name: 7f15a68a-45e2-4006-a7cf-f5ec6148febd
spec:
  description: "Function that is invoked when a new message arrives on the iot/tyre/pressure queue, and insert data in the Database."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-mqtt_consume_tyre_pressure:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      kind: mqtt
      attributes:
        subscriptions:
          - topic: iot/tyre/pressure
            qos: 0
      workerAllocatorName: ""
      url: "guest:guest@172.22.91.115:1883"
  build:
    image: ""
    noCache: false
    offline: false
    dependencies: []
    runtimeAttributes:
      repositories: []
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBteXNxbCA9IHJlcXVpcmUoJ215c3FsJyk7Cgp2YXIgRlVOQ1RJT05fTkFNRSA9ICJtcXR0X2NvbnN1bWVfdHlyZV9wcmVzc3VyZSI7CgovKgp2YXIgREFUQUJBU0VfSE9TVCA9ICI5NS4xMTAuMTcxLjE4IjsKdmFyIERBVEFCQVNFX1BPUlQgPSAiMzMwNiI7CnZhciBEQVRBQkFTRV9VU0VSID0gIjEwMDQ5XzIyOSI7CnZhciBEQVRBQkFTRV9QQVNTV09SRCA9ICJtaWtlODE4MCI7ICAKdmFyIERBVEFCQVNFX05BTUUgPSAiZGJpbnN0YW5jZV8xMDA0OV8xIjsgCnZhciBEQVRBQkFTRV9UQUJMRV9OQU1FID0gInNjaW90X3Byb2plY3QiOwoqLwoKdmFyIERBVEFCQVNFX0hPU1QgPSAiMTcyLjIyLjkxLjExNSI7CnZhciBEQVRBQkFTRV9QT1JUID0gIjMzMDYwIjsKdmFyIERBVEFCQVNFX1VTRVIgPSAicm9vdCI7CnZhciBEQVRBQkFTRV9QQVNTV09SRCA9ICIxMjM0IjsgIAp2YXIgREFUQUJBU0VfTkFNRSA9ICJzY2lvdF9wcm9qZWN0IjsgCnZhciBEQVRBQkFTRV9UQUJMRV9OQU1FID0gInR5cmVfcHJlc3N1cmUiOwoKCgpmdW5jdGlvbiBzZW5kX2ZlZWRiYWNrKGVyciwgbXNnKXsKICAgIGlmIChlcnIpIHRocm93IGVycjsKICAgIAogICAgdmFyIHEgPSAnaW90L3R5cmUvbG9ncyc7CiAgICBhbXFwLmNvbm5lY3QoJ2FtcXA6Ly9ndWVzdDpndWVzdEAxNzIuMjIuOTEuMTE1OjU2NzInKS50aGVuKGZ1bmN0aW9uKGNvbm4pIHsKICAgICAgICByZXR1cm4gY29ubi5jcmVhdGVDaGFubmVsKCkudGhlbihmdW5jdGlvbihjaCkgewogICAgICAgICAgICB2YXIgb2sgPSBjaC5hc3NlcnRRdWV1ZShxLCB7ZHVyYWJsZTogZmFsc2V9KTsKICAgICAgICAgICAgcmV0dXJuIG9rLnRoZW4oZnVuY3Rpb24oX3FvaykgewogICAgICAgICAgICAgICAgY2guc2VuZFRvUXVldWUocSwgQnVmZmVyLmZyb20obXNnKSk7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygiIFt4XSBTZW50ICclcyciLCBtc2cpOwogICAgICAgICAgICAgICAgcmV0dXJuIGNoLmNsb3NlKCk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pLmZpbmFsbHkoZnVuY3Rpb24oKSB7IAogICAgICAgICAgICBjb25uLmNsb3NlKCk7CiAgICAgICAgfSk7CiAgICB9KS5jYXRjaChjb25zb2xlLndhcm4pOwp9CgoKZnVuY3Rpb24gaW5zZXJ0RGF0YShkYXRhLCBjYWxsYmFjayl7CiAgICB2YXIgcHJlc3N1cmU7CiAgICB2YXIgdGltZXN0YW1wOwogICAgCiAgICBmdW5jdGlvbiBmb3JtYXREYXRhKGRhdGEpewogICAgICAgIHZhciBpbmRleDEgPSBkYXRhLmluZGV4T2YoIi0iLCAwKTsKCSAgICB2YXIgaW5kZXgyID0gaW5kZXgxICsgMTsKCgkgICAgLy9JbCBjYXJhdHRlcmUgbGEgY3VpIHBvc2l6aW9uZSDDqCBpbmRpY2F0YSBkYWwgcHJpbW8gcGFyYW1ldHJvIMOoIGluY2x1c28uCiAgICAgICAgLy9JbCBjYXJhdHRlcmUgbGEgY3VpIHBvc2l6aW9uZSDDqCBpbmRpY2F0YSBkYWwgc2Vjb25kbyBwYXJhbWV0cm8gTk9OIMOoIGluY2x1c28uCiAgICAgICAgcHJlc3N1cmUgPSBkYXRhLnN1YnN0cmluZygwLCBpbmRleDEpOwoJICAgIHRpbWVzdGFtcCA9IGRhdGEuc3Vic3RyaW5nKGluZGV4Mik7CiAgICB9CiAgICAKICAgIGZvcm1hdERhdGEoZGF0YSk7CiAgCgl2YXIgY29uID0gbXlzcWwuY3JlYXRlQ29ubmVjdGlvbih7ICAKCQlob3N0OiBEQVRBQkFTRV9IT1NULAogICAgICAgIHBvcnQ6IERBVEFCQVNFX1BPUlQsCgkJdXNlcjogREFUQUJBU0VfVVNFUiwgIAoJCXBhc3N3b3JkOiBEQVRBQkFTRV9QQVNTV09SRCwgIAoJCWRhdGFiYXNlOiBEQVRBQkFTRV9OQU1FICAgICAgCgl9KTsKCgl2YXIgbGFzdF9pZD0wOwoKCWNvbi5jb25uZWN0KGZ1bmN0aW9uKGVycikgeyAgCgkJaWYgKGVycikgdGhyb3cgZXJyOyAgCgkJY29uc29sZS5sb2coIkNvbm5lY3RlZCEiKTsgCgkJdmFyIHNxbDEgPSAiU0VMRUNUIE1BWChpZCkgRlJPTSAiICsgREFUQUJBU0VfTkFNRSArICIuIiArIERBVEFCQVNFX1RBQkxFX05BTUUrIjsiIAoKCQljb24ucXVlcnkoc3FsMSwgZnVuY3Rpb24gKGVyciwgcmVzdWx0KSB7ICAKCQkJaWYgKGVycikgdGhyb3cgZXJyOwogICAgICAgICAgICBpZiAocmVzdWx0PT1udWxsKXsKICAgICAgICAgICAgICAgIGxhc3RfaWQ9MDsKICAgICAgICAgICAgfSBlbHNlewogICAgICAgICAgICAgICAgbGFzdF9pZCA9IHJlc3VsdCsxOyAgCiAgICAgICAgICAgIH0KCQkJY29uc29sZS5sb2coIkxhc3QgaWQ6ICIgKyByZXN1bHQudG9TdHJpbmcoKSk7CgkJfSk7IAoKICAgIHZhciBzcWwyID0gIklOU0VSVCBJTlRPICIgKyBEQVRBQkFTRV9OQU1FICsgIi4iICsgREFUQUJBU0VfVEFCTEVfTkFNRSsiIChpZCwgcHJlc3N1cmUsIHRpbWVzdGFtcCkgVkFMVUVTICgnIisgbGFzdF9pZCArIicsICciK3ByZXNzdXJlKyInLCAnIit0aW1lc3RhbXArIicpIjsgCgoJCWNvbi5xdWVyeShzcWwyLCBmdW5jdGlvbiAoZXJyLCByZXN1bHQpIHsgIAoJCQlpZiAoZXJyKSB0aHJvdyBlcnI7ICAKCQkJY29uc29sZS5sb2coIjEgcmVjb3JkIGluc2VydGVkIik7ICAKICAgICAgICAgICAgdmFyIG1zZyA9ICJGdW5jdGlvbiAnIitGVU5DVElPTl9OQU1FKyInIGhhcyBiZWVuIHRyaWdnZXJlZCBieSB0aGUgZm9sbG93aW5nIG1lc3NhZ2UgcmVjZWl2ZWQgb24gdG9waWMgJ2lvdC90eXJlL3ByZXNzdXJlJzogIisgcHJlc3N1cmUudG9TdHJpbmcoKSArICItIiArIHRpbWVzdGFtcC50b1N0cmluZygpOwogICAgICAgICAgICBjYWxsYmFjayhudWxsLCBtc2cpOwoJCX0pOwoKCX0pOyAgCn0KCmZ1bmN0aW9uIGJpbjJTdHJpbmcoYXJyYXkpewoJdmFyIHJlc3VsdCA9ICIiOwoJZm9yKHZhciBpID0gMDsgaSA8IGFycmF5Lmxlbmd0aDsgKytpKXsKCQlyZXN1bHQrPSAoU3RyaW5nLmZyb21DaGFyQ29kZShhcnJheVtpXSkpOwoJfQoJcmV0dXJuIHJlc3VsdDsKfQoKZXhwb3J0cy5oYW5kbGVyID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKCXZhciBfZXZlbnQgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KGV2ZW50KSk7Cgl2YXIgX2RhdGEgPSBiaW4yU3RyaW5nKF9ldmVudC5ib2R5LmRhdGEpOwogICAgCiAgICBpbnNlcnREYXRhKF9kYXRhLCBmdW5jdGlvbihlcnIsIGRhdGEpewogICAgICAgIHNlbmRfZmVlZGJhY2sobnVsbCwgZGF0YSk7CiAgICB9KQogICAgCiAgICBjb250ZXh0LmNhbGxiYWNrKCJmZWVkYmFjayIpOwp9Ow==
    commands:
      - 'npm install amqplib'
      - 'npm install mysql'
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
