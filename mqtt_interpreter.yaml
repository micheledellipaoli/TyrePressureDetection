metadata:
  name: mqtt_interpreter
  labels:
    nuclio.io/project-name: 7f15a68a-45e2-4006-a7cf-f5ec6148febd
spec:
  description: "Function invoked when a new message arrives on the iot/tyre/pressure queue. It retrieves the last 5 rows from Database, interpret datas, and send a message on the iot/console queue."
  handler: "main:handler"
  runtime: nodejs
  resources: {}
  image: "nuclio/processor-mqtt_interpreter:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 75
  triggers:
    myMqttTrigger:
      class: ""
      kind: mqtt
      url: "guest:guest@172.30.92.172:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/tyre/pressure
  build:
    image: ""
    noCache: false
    offline: false
    dependencies: []
    runtimeAttributes:
      repositories: []
    functionSourceCode: dmFyIGFtcXAgPSByZXF1aXJlKCdhbXFwbGliJyk7CnZhciBteXNxbCA9IHJlcXVpcmUoJ215c3FsJyk7IAoKdmFyIEZVTkNUSU9OX05BTUUgPSAibXF0dF9pbnRlcnByZXRlciI7CgpmdW5jdGlvbiByZXRyaWV2ZURhdGEoY2FsbGJhY2spewogICAgCiAgCXZhciBjb24gPSBteXNxbC5jcmVhdGVDb25uZWN0aW9uKHsgIAoJCWhvc3Q6ICI5NS4xMTAuMTcxLjE4IiwKCQlwb3J0OiAiMzMwNiIsICAKCQl1c2VyOiAiMTAwNDlfMjI5IiwgIAoJCXBhc3N3b3JkOiAibWlrZTgxODAiLCAgCgkJZGF0YWJhc2U6ICJkYmluc3RhbmNlXzEwMDQ5XzEiLCAgCgl9KTsKCgljb24uY29ubmVjdChmdW5jdGlvbihlcnIpIHsgIAoJCWlmIChlcnIpIHRocm93IGVycjsgIAoJCWNvbnNvbGUubG9nKCJDb25uZWN0ZWQhIik7CgoJCXZhciBzcWwxID0gIlNFTEVDVCAqIEZST00gKFNFTEVDVCAqIEZST00gZGJpbnN0YW5jZV8xMDA0OV8xLnNjaW90X3Byb2plY3QgT1JERVIgQlkgaWQgREVTQyBMSU1JVCA1KSBzdWIgT1JERVIgQlkgdGltZXN0YW1wIEFTQzsiOwoJCQoJCWNvbi5xdWVyeShzcWwxLCBmdW5jdGlvbiAoZXJyLCByZXN1bHRzKSB7ICAKCQkJaWYgKGVycikgdGhyb3cgZXJyOwogICAgICAJCWNvbnNvbGUubG9nKHJlc3VsdHMubGVuZ3RoICsgIiByZWNvcmRzIHJldHJpZXZlZFxuIik7CiAgICAgICAgICAgIAogICAgICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTsKCQl9KTsKCX0pOyAKfQoKZnVuY3Rpb24gaW50ZXJwcmV0RGF0YShlcnIsIHJlc3VsdHMsIGNhbGxiYWNrKSB7CiAgICBpZiAoZXJyKSB0aHJvdyBlcnI7CiAgICAKICAgIHZhciBwcmVzc3VyZVZhbHVlcyA9IG5ldyBBcnJheSgpOwogICAgdmFyIHRpbWVzdGFtcFZhbHVlcyA9IG5ldyBBcnJheSgpOwogICAgdmFyIG51bVJlc3VsdHMgPSByZXN1bHRzLmxlbmd0aDsKICAgIHZhciBkZWx0YSA9IDA7CgogCXZhciBzdGFuZGFyZFByZXNzdXJlID0gMzAwMDsKCXZhciBtZXNzYWdlPSIiOwoKICAgIC8vIGl0ZXJhIHR1dHRlIGxlIHJpZ2hlIGRlbGwnb2dnZXR0byByZXN1bHQKCWZvcih2YXIgaT0wOyBpPHJlc3VsdHMubGVuZ3RoOyBpKyspewoJCXByZXNzdXJlVmFsdWVzW2ldID0gcmVzdWx0c1tpXS5wcmVzc3VyZS50b1N0cmluZygpOwoJCXRpbWVzdGFtcFZhbHVlc1tpXSA9IHJlc3VsdHNbaV0udGltZXN0YW1wLnRvU3RyaW5nKCk7CgkJY29uc29sZS5sb2coInByZXNzdXJlOiAiK3ByZXNzdXJlVmFsdWVzW2ldKTsKICAgICAgCWNvbnNvbGUubG9nKCJ0aW1lc3RhbXA6ICIrdGltZXN0YW1wVmFsdWVzW2ldKTsKCX07CiAgICAKCS8vQ2FzbyAxOiBOdW1lcm8gZGkgcmVjb3JkIHByZXNlbnRpIG5lbCBEQiBtaW5vcmUgZGkgNQoJaWYobnVtUmVzdWx0czw1KXsKCQkvL0Nhc28gMS4xOiB1bHRpbW8gdmFsb3JlIG1pbm9yZSBkaSBxdWVsbG8gc3RhbmRhcmQKCQlpZiAocHJlc3N1cmVWYWx1ZXNbbnVtUmVzdWx0cy0xXSA8IHN0YW5kYXJkUHJlc3N1cmUpewoJCQltZXNzYWdlID0gIkxvdyBUeXJlIFByZXNzdXJlIHJlZ2lzdGVyZWQhIjsKCQl9ZWxzZXsKCQkJLy9DYXNvIDEuMjogcGVudWxtdGltbyB2YWxvcmUgbWlub3JlIGRpIHF1ZWxsbyBzdGFuZGFyZCAmJiB1bHRpbW8gdmFsb3JlIG1hZ2dpb3JlIG8gdWd1YWxlIGRpIHF1ZWxsbyBzdGFuZGFyZAoJCQlpZiAoIChwcmVzc3VyZVZhbHVlc1tudW1SZXN1bHRzLTJdIDwgc3RhbmRhcmRQcmVzc3VyZSkgJiYgKHByZXNzdXJlVmFsdWVzW251bVJlc3VsdHMtMV0gPj0gc3RhbmRhcmRQcmVzc3VyZSkgKXsKCQkJCW1lc3NhZ2UgPSAiVHlyZSBwcmVzc3VyZSByZXN0b3JlZCEiOwoJCQl9CgkJfQoJfWVsc2V7CgkJLy9DYXNvIDI6IE51bWVybyBkaSByZWNvcmQgcHJlc2VudGkgbmVsIERCIG1hZ2dpb3JlIG8gdWd1YWxlIGRpIDUgCiAgICAgICAgCiAgICAgICAgLy9DYXNvIDIuMTogdWx0aW1vIHZhbG9yZSBtaW5vcmUgZGkgcXVlbGxvIHN0YW5kYXJkCgkJaWYgKHByZXNzdXJlVmFsdWVzW251bVJlc3VsdHMtMV0gPCBzdGFuZGFyZFByZXNzdXJlKXsKCQkJbWVzc2FnZSA9ICJMb3cgVHlyZSBQcmVzc3VyZSByZWdpc3RlcmVkISI7CgkJfWVsc2V7CgkJCS8vQ2FzbyAyLjI6IHBlbnVsbXRpbW8gdmFsb3JlIG1pbm9yZSBkaSBxdWVsbG8gc3RhbmRhcmQgJiYgdWx0aW1vIHZhbG9yZSBtYWdnaW9yZSBvIHVndWFsZSBkaSBxdWVsbG8gc3RhbmRhcmQKCQkJaWYgKCAocHJlc3N1cmVWYWx1ZXNbbnVtUmVzdWx0cy0yXSA8IHN0YW5kYXJkUHJlc3N1cmUpICYmIChwcmVzc3VyZVZhbHVlc1tudW1SZXN1bHRzLTFdID49IHN0YW5kYXJkUHJlc3N1cmUpICl7CgkJCQltZXNzYWdlID0gIlR5cmUgcHJlc3N1cmUgcmVzdG9yZWQhIjsKCQkJfQoJCX0KICAgICAgICAKICAgICAgICAvL0Nhc28gMi4zOiB2YWxvcmkgZGkgcHJlc3Npb25lIGRlY3Jlc2NlbnRpCiAgICAgICAgaWYoIChwcmVzc3VyZVZhbHVlc1swXSA8IHN0YW5kYXJkUHJlc3N1cmUpICYmIChwcmVzc3VyZVZhbHVlc1swXT49IHByZXNzdXJlVmFsdWVzWzFdKSAmJiAocHJlc3N1cmVWYWx1ZXNbMV0+PSBwcmVzc3VyZVZhbHVlc1syXSkgJiYgKHByZXNzdXJlVmFsdWVzWzJdPj0gcHJlc3N1cmVWYWx1ZXNbM10pICYmIChwcmVzc3VyZVZhbHVlc1szXT49IHByZXNzdXJlVmFsdWVzWzRdKSApewoJCQkJCQkKCQkJdmFyIHN0YXJ0VGltZSA9IERhdGUucGFyc2UobmV3IERhdGUodGltZXN0YW1wVmFsdWVzWzBdLnRvU3RyaW5nKCkpKTsKCQkJdmFyIGVuZFRpbWUgPSBEYXRlLnBhcnNlKHRpbWVzdGFtcFZhbHVlc1s0XS50b1N0cmluZygpKTsKCgkJCS8vRGlmZmVyZW56YSBpbiBtaW51dGkKCQkJZGVsdGEgPSBNYXRoLmZsb29yKCgoZW5kVGltZS1zdGFydFRpbWUpLzEwMDAvNjApKTsKCQkJCgkJCQkvL0Nhc28gMi4xOiBEaWZmZXJlbnphIGRpIHRpbWVzdGFtcCBtaW5vcmUgZGkgMSBtaW51dG8KCQkJaWYoZGVsdGE8MSl7CgkJCQltZXNzYWdlID0gIldhcm5pbmcsIHBvc3NpYmxlIHR5cmUgcHVuY3R1cmUhIjsKCQkJfWVsc2V7CgkJCQkvL0Nhc28gMi4yOiBEaWZmZXJlbnphIGRpIHRpbWVzdGFtcCBtYWdnaW9yZSBvIHVndWFsZSBkaSAxIG1pbnV0bwoJCQkJbWVzc2FnZSA9ICJMb3cgVHlyZSBQcmVzc3VyZSByZWdpc3RlcmVkISI7CgkJCX0KCQl9ZWxzZXsKCQkJLy9DYXNvIDM6IE51bWVybyBkaSB2YWxvcmkgcHJlc2VudGkgbmVsIERCIG1hZ2dpb3JlIG8gdWd1YWxlIGRpIDUgJiYgcGVudWxtdGltbyB2YWxvcmUgbWlub3JlIGRpIHF1ZWxsbyBzdGFuZGFyZCAmJiB1bHRpbW8gdmFsb3JlIG1hZ2dpb3JlIG8gdWd1YWxlIGRpIHF1ZWxsbyBzdGFuZGFyZAoJCQlpZiAoIChwcmVzc3VyZVZhbHVlc1szXSA8IHN0YW5kYXJkUHJlc3N1cmUpICYmIChwcmVzc3VyZVZhbHVlc1s0XSA+PSBzdGFuZGFyZFByZXNzdXJlKSApewoJCQkJbWVzc2FnZSA9ICJUeXJlIFByZXNzdXJlIHJlc3RvcmVkISI7CgkJCX1lbHNlewogICAgICAgIAkJCS8vQ2FzbyA0LjE6IHBlbnVsdGltbyB2YWxvcmUgbWFnZ2lvcmUgbyB1Z3VhbGUgZGkgcXVlbGxvIHN0YW5kYXJkICYmIHVsdGltbyB2YWxvcmUgbWlub3JlIGRpIHF1ZWxsbyBzdGFuZGFyZAogICAgICAgIAkJCWlmKCAocHJlc3N1cmVWYWx1ZXNbM10gPj0gc3RhbmRhcmRQcmVzc3VyZSkgJiYgKHByZXNzdXJlVmFsdWVzWzRdIDwgc3RhbmRhcmRQcmVzc3VyZSkgKXsKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9ICJMb3cgVHlyZSBQcmVzc3VyZSByZWdpc3RlcmVkISI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgIAkJCQogICAgICAgICAgICAgICAgICAgIC8vQ2FzbyA0LjI6IHZhbG9yaSBkaSBwcmVzc2lvbmUgTk9OIGRlY3Jlc2NlbnRpLCBlZCB1bHRpbW8gdmFsb3JlIG1pbm9yZSBkaSBxdWVsbG8gc3RhbmRhcmQKICAgICAgICAJCQlpZiggISgocHJlc3N1cmVWYWx1ZXNbMF0+PSBwcmVzc3VyZVZhbHVlc1sxXSkgJiYgKHByZXNzdXJlVmFsdWVzWzFdPj0gcHJlc3N1cmVWYWx1ZXNbMl0pICYmIChwcmVzc3VyZVZhbHVlc1syXT49IHByZXNzdXJlVmFsdWVzWzNdKSAmJiAocHJlc3N1cmVWYWx1ZXNbM10+PSBwcmVzc3VyZVZhbHVlc1s0XSkpICYmIHByZXNzdXJlVmFsdWVzWzRdIDwgc3RhbmRhcmRQcmVzc3VyZSkgewogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gIkxvdyBUeXJlIFByZXNzdXJlIHJlZ2lzdGVyZWQhIjsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vQ2FzbyA0LjM6IHBlbnVsdGltbyBlZCB1bHRpbW8gdmFsb3JlIG1hZ2dpb3JpIGRpIHF1ZWxsbyBzdGFuZGFyZAogICAgICAgICAgICAgICAgICAgIGlmKCAocHJlc3N1cmVWYWx1ZXNbM10gPj0gc3RhbmRhcmRQcmVzc3VyZSkgJiYgKHByZXNzdXJlVmFsdWVzWzRdID49IHN0YW5kYXJkUHJlc3N1cmUpICl7CiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSAiVHlyZSBQcmVzc3VyZSBvcHRpbWFsISI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAJCQl9ICAgICAgCgkJfQoJfQogICAgY29uc29sZS5sb2coJ21lc3NhZ2U6ICcrbWVzc2FnZSk7CiAgCWNhbGxiYWNrKG51bGwsIG1lc3NhZ2UpOwp9CgpmdW5jdGlvbiBzZW5kX2ZlZWRiYWNrKGVyciwgbXNnKXsKICAgIGlmKGVycikgdGhyb3cgZXJyOwogICAgCiAgICBjb25zb2xlLmxvZygiXG5zZW5kX2ZlZWRiYWNrW21zZ106ICIrbXNnKTsKCXZhciBxID0gJ2lvdC9jb25zb2xlJzsKCWFtcXAuY29ubmVjdCgnYW1xcDovL2d1ZXN0Omd1ZXN0QDE3Mi4zMC45Mi4xNzI6NTY3MicpLnRoZW4oZnVuY3Rpb24oY29ubikgewoJCXJldHVybiBjb25uLmNyZWF0ZUNoYW5uZWwoKS50aGVuKGZ1bmN0aW9uKGNoKSB7CgkJCXZhciBvayA9IGNoLmFzc2VydFF1ZXVlKHEsIHtkdXJhYmxlOiBmYWxzZX0pOwoJCQlyZXR1cm4gb2sudGhlbihmdW5jdGlvbihfcW9rKSB7CgkJCQljaC5zZW5kVG9RdWV1ZShxLCBCdWZmZXIuZnJvbShtc2cpKTsKCQkJCWNvbnNvbGUubG9nKCIgW3hdIFNlbnQgJyVzJyIsIG1zZyk7CgkJCQlyZXR1cm4gY2guY2xvc2UoKTsKCQkJfSk7CgkJfSkuZmluYWxseShmdW5jdGlvbigpIHsKCQkJY29ubi5jbG9zZSgpOwoJCX0pOwoJfSkuY2F0Y2goY29uc29sZS53YXJuKTsKfQoKZXhwb3J0cy5oYW5kbGVyID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXsKCSAgICByZXRyaWV2ZURhdGEoZnVuY3Rpb24oZXJyLCBkYXRhKXsKICAgICAgICAgICAgaW50ZXJwcmV0RGF0YShudWxsLCBkYXRhLCBmdW5jdGlvbihlcnIsIGRhdGEpIHsKICAgICAgICAgICAgICAgIHNlbmRfZmVlZGJhY2sobnVsbCwgZGF0YSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pCiAgICB9LCAxMDAwKTsKICAgIGNvbnRleHQuY2FsbGJhY2soImZlZWRiYWNrIik7Cn07
    commands:
      - 'npm install amqplib'
      - 'npm install mysql'
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
